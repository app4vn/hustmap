<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Bản đồ khuôn viên - Tìm Kiếm Nâng Cao</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px;
      box-sizing: border-box;
      background-color: #f0f0f0;
      overscroll-behavior: none; 
      height: 100vh;
      overflow: hidden;
    }

    /* --- Search Bar Area --- */
    .search-area-container {
      width: 100%;
      max-width: 900px;
      padding: 8px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 8px;
      box-sizing: border-box;
      position: relative; /* For positioning search results */
      z-index: 1000; /* Để search results nổi lên trên */
    }
    #searchInput {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    #searchResultsContainer {
      position: absolute;
      top: 100%; /* Ngay dưới ô input */
      left: 8px; /* Căn lề với padding của search-area-container */
      right: 8px;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 999; /* Dưới search input một chút nhưng trên map */
      display: none; /* Ẩn mặc định */
    }
    #searchResultsContainer ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #searchResultsContainer li {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #searchResultsContainer li:last-child {
      border-bottom: none;
    }
    #searchResultsContainer li:hover {
      background-color: #f0f0f0;
    }
    #searchResultsContainer .no-results {
      padding: 10px;
      color: #777;
      text-align: center;
    }

    .map-container {
      width: 100%;
      max-width: 900px;
      border: 1px solid #007bff;
      border-radius: 8px;
      overflow: hidden;
      background-color: white;
      flex-grow: 1; 
      display: flex; 
      margin-bottom: 8px;
    }

    svg#campusMap {
      width: 100%;
      height: 100%;
      display: block;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    svg#campusMap.grabbing { cursor: grabbing; }

    rect.building-rect {
      fill: transparent;
      pointer-events: all;
      stroke: rgba(255, 0, 0, 0.6);
      stroke-width: 1px; 
      transition: stroke 0.3s ease, stroke-width 0.3s ease; /* Animation cho highlight */
    }
    rect.building-rect.search-highlight {
        stroke: #00ff00; /* Màu xanh lá cây sáng cho highlight */
        stroke-width: 3px;
    }

    .divider-line { /* Giữ nguyên */ }
    
    .info-panel { /* Giữ nguyên */ }
    .bottom-controls-container { /* Giữ nguyên */ }
    .quadrant-grid-controls { /* Giữ nguyên */ }
    .quadrant-grid-controls button,
    .bottom-controls-container button.reset-zoom { /* Giữ nguyên */ }

    /* Style còn lại giữ nguyên như bản trước */
    .divider-line { stroke: rgba(128, 128, 128, 0.4); stroke-width: 1px; stroke-dasharray: 3,3; pointer-events: none;}
    .info-panel { width: 100%; max-width: 900px; padding: 10px; background: #fff; border: 1px solid #ccc; box-sizing: border-box; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-shrink: 0; max-height: 20vh; overflow-y: auto; margin-bottom: 8px; }
    .info-panel h3 { margin-top: 0; color: #007bff; font-size: 1.1em; }
    .info-panel p { margin: 5px 0 0; line-height: 1.4; color: #333; font-size: 0.9em; }
    .placeholder { color: #999; font-style: italic; }
    .bottom-controls-container { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 8px; background-color: #fff; border-radius: 8px; box-shadow: 0 -1px 3px rgba(0,0,0,0.05); width: 100%; max-width: 900px; box-sizing: border-box; flex-shrink: 0; }
    .quadrant-grid-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; width: 100%; max-width: 300px; }
    .quadrant-grid-controls button, .bottom-controls-container button.reset-zoom { padding: 8px 10px; font-size: 13px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; transition: background-color 0.2s ease; width: 100%; }
    .quadrant-grid-controls button:hover, .bottom-controls-container button.reset-zoom:hover { background-color: #0056b3; }
    .bottom-controls-container button.reset-zoom { background-color: #6c757d; max-width: 300px; }
    .bottom-controls-container button.reset-zoom:hover { background-color: #545b62; }

  </style>
</head>
<body>

  <div class="search-area-container">
    <input type="text" id="searchInput" placeholder="Tìm tên hoặc mã tòa nhà...">
    <div id="searchResultsContainer">
      <ul id="searchResultsList"></ul>
    </div>
  </div>

  <div class="map-container">
    <svg id="campusMap" viewBox="0 0 970 910" xmlns="http://www.w3.org/2000/svg">
      <image href="anh-nen-goc.jpg" x="0" y="0" width="970" height="910" />
      <line class="divider-line" x1="485" y1="0" x2="485" y2="910" />
      <line class="divider-line" x1="0" y1="455" x2="970" y2="455" />
      
      <rect class="building-rect" id="toaC2" x="140" y="320" width="40" height="120" />
      <rect class="building-rect" id="toaC9" x="60" y="450" width="130" height="30" />
      <rect class="building-rect" id="toaHoithao" x="140" y="270" width="40" height="40" />
      <rect class="building-rect" id="toaC1" x="150" y="200" width="270" height="60" />
      <rect class="building-rect" id="toaC3" x="400" y="280" width="100" height="30" />
      <rect class="building-rect" id="toaC4" x="395" y="350" width="105" height="30" />
      <rect class="building-rect" id="toaC5" x="395" y="420" width="105" height="30" />
      <rect class="building-rect" id="toaC10" x="397" y="480" width="100" height="30" />
      <rect class="building-rect" id="toaC7" x="540" y="410" width="100" height="100" />
      <rect class="building-rect" id="toaThuvien" x="440" y="570" width="90" height="120" />
      <rect class="building-rect" id="toaHotien" x="250" y="690" width="150" height="110" />
      <rect class="building-rect" id="toaD6" x="100" y="680" width="120" height="30" />
      <rect class="building-rect" id="toaD8" x="100" y="750" width="120" height="30" />
      <rect class="building-rect" id="toaD2a" x="80" y="560" width="70" height="50" />
      <rect class="building-rect" id="toaD2b" x="160" y="560" width="70" height="50" />
      <rect class="building-rect" id="toaVietduc" x="240" y="560" width="70" height="50" />
      <rect class="building-rect" id="toaD2d" x="320" y="560" width="80" height="50" />
      <rect class="building-rect" id="toaC3b" x="540" y="230" width="90" height="100" />
      <rect class="building-rect" id="toaC1b" x="460" y="210" width="50" height="50" />
      <rect class="building-rect" id="toaD3" x="580" y="560" width="70" height="40" />
      <rect class="building-rect" id="toaD5" x="580" y="620" width="70" height="40" />
      <rect class="building-rect" id="toaD35" x="660" y="560" width="40" height="100" />
      <rect class="building-rect" id="toaB6" x="750" y="300" width="100" height="30" />
      <rect class="building-rect" id="toaKtx" x="750" y="345" width="100" height="65" />
      <rect class="building-rect" id="toaB7" x="750" y="420" width="100" height="30" />
      <rect class="building-rect" id="toaB8" x="750" y="470" width="110" height="30" />
      <rect class="building-rect" id="toaB5" x="870" y="310" width="80" height="40" />
      <rect class="building-rect" id="toaB9" x="870" y="370" width="80" height="40" />
      <rect class="building-rect" id="toaB1" x="780" y="565" width="130" height="130" />
      <rect class="building-rect" id="toaD4" x="20" y="695" width="50" height="45" />
      <rect class="building-rect" id="toaVuonhoa" x="230" y="280" width="110" height="140" />
      <rect class="building-rect" id="toaD7" x="610" y="670" width="60" height="60" />
    </svg>
  </div>

  <div class="info-panel" id="infoPanel">
    <h3>Thông tin tòa nhà</h3>
    <p class="placeholder">Chạm hoặc tìm kiếm tòa nhà để xem chi tiết.</p>
  </div>

  <div class="bottom-controls-container">
    <div class="quadrant-grid-controls">
      <button id="zoomQ1Bottom">G1</button>
      <button id="zoomQ2Bottom">G2</button>
      <button id="zoomQ3Bottom">G3</button>
      <button id="zoomQ4Bottom">G4</button>
    </div>
    <button id="resetZoomBtnBottom" class="reset-zoom">Xem Toàn Bộ</button>
  </div>

  <script>
    const infoPanel = document.getElementById('infoPanel');
    const campusMap = document.getElementById('campusMap');
    const searchInput = document.getElementById('searchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const searchResultsList = document.getElementById('searchResultsList');

    const SVG_ORIGINAL_WIDTH = 970;
    const SVG_ORIGINAL_HEIGHT = 910;
    let currentViewBox = { x: 0, y: 0, width: SVG_ORIGINAL_WIDTH, height: SVG_ORIGINAL_HEIGHT };
    const ZOOM_FACTOR = 1.2; 
    const MIN_ZOOM_WIDTH = 30; 
    const MAX_ZOOM_WIDTH = SVG_ORIGINAL_WIDTH * 3;

    let isPointerDown = false;
    let pointerStartCoords = { x: 0, y: 0 };
    let viewBoxOnPointerDown = { x: 0, y: 0 };
    let initialPinchDistance = 0;
    let isPinching = false;
    let tapStart = { x:0, y:0, time:0 };
    const TAP_THRESHOLD_MS = 250;
    const TAP_MOVE_THRESHOLD_PX = 10;
    let debounceTimer;
    let highlightTimeout;

    const halfWidth = SVG_ORIGINAL_WIDTH / 2;
    const halfHeight = SVG_ORIGINAL_HEIGHT / 2;
    const quadrantViewBoxes = { /* giữ nguyên */ };
    // ... (Copy quadrantViewBoxes từ bản trước)
    quadrantViewBoxes.q1 = { x: 0, y: 0, width: halfWidth, height: halfHeight };
    quadrantViewBoxes.q2 = { x: halfWidth, y: 0, width: halfWidth, height: halfHeight };
    quadrantViewBoxes.q3 = { x: 0, y: halfHeight, width: halfWidth, height: halfHeight };
    quadrantViewBoxes.q4 = { x: halfWidth, y: halfHeight, width: halfWidth, height: halfHeight };


    function setMapViewBox(vb) { /* giữ nguyên */ }
    // ... (Copy setMapViewBox, screenToSVGCoords, zoomViewBox, mouse handlers, touch handlers từ bản trước)
    // Hàm setMapViewBox
    function setMapViewBox(vb) {
      currentViewBox = { ...vb };
      currentViewBox.x = Math.max(-SVG_ORIGINAL_WIDTH * 0.5, Math.min(currentViewBox.x, SVG_ORIGINAL_WIDTH * 1.5 - currentViewBox.width));
      currentViewBox.y = Math.max(-SVG_ORIGINAL_HEIGHT * 0.5, Math.min(currentViewBox.y, SVG_ORIGINAL_HEIGHT * 1.5 - currentViewBox.height));
      campusMap.setAttribute('viewBox', `${currentViewBox.x} ${currentViewBox.y} ${currentViewBox.width} ${currentViewBox.height}`);
    }

    // Hàm screenToSVGCoords
    function screenToSVGCoords(screenX, screenY) {
        const pt = campusMap.createSVGPoint();
        pt.x = screenX;
        pt.y = screenY;
        const CTM = campusMap.getScreenCTM();
        return CTM ? pt.matrixTransform(CTM.inverse()) : null;
    }

    // Hàm zoomViewBox
    function zoomViewBox(zoomRatio, pivotSVG) {
        let newWidth = currentViewBox.width * zoomRatio;
        let newHeight = currentViewBox.height * zoomRatio;

        if (newWidth < MIN_ZOOM_WIDTH) {
            newWidth = MIN_ZOOM_WIDTH;
            newHeight = MIN_ZOOM_WIDTH * (SVG_ORIGINAL_HEIGHT / SVG_ORIGINAL_WIDTH);
            if (zoomRatio > 1 && currentViewBox.width <= MIN_ZOOM_WIDTH) return; // Đã ở mức zoom nhỏ nhất, không zoom out nữa
        }
        if (newWidth > MAX_ZOOM_WIDTH) {
            newWidth = MAX_ZOOM_WIDTH;
            newHeight = MAX_ZOOM_WIDTH * (SVG_ORIGINAL_HEIGHT / SVG_ORIGINAL_WIDTH);
             if (zoomRatio < 1 && currentViewBox.width >= MAX_ZOOM_WIDTH) return; // Đã ở mức zoom lớn nhất, không zoom in nữa
        }
        
        let newX, newY;
        if (pivotSVG) {
            newX = pivotSVG.x - (pivotSVG.x - currentViewBox.x) * (newWidth / currentViewBox.width);
            newY = pivotSVG.y - (pivotSVG.y - currentViewBox.y) * (newHeight / currentViewBox.height);
        } else {
            newX = currentViewBox.x + (currentViewBox.width - newWidth) / 2;
            newY = currentViewBox.y + (currentViewBox.height - newHeight) / 2;
        }
        setMapViewBox({ x: newX, y: newY, width: newWidth, height: newHeight });
    }

    // Mouse Event Handlers
    campusMap.addEventListener('mousedown', (event) => {
        if (event.button !== 0) return; // Chỉ xử lý chuột trái
        isPointerDown = true;
        pointerStartCoords = { x: event.clientX, y: event.clientY };
        viewBoxOnPointerDown = { x: currentViewBox.x, y: currentViewBox.y };
        campusMap.classList.add('grabbing');
        tapStart = { x: event.clientX, y: event.clientY, time: Date.now() };
    });
    campusMap.addEventListener('mousemove', (event) => {
        if (!isPointerDown || isPinching) return;
        const dxScreen = event.clientX - pointerStartCoords.x;
        const dyScreen = event.clientY - pointerStartCoords.y;
        const clientRect = campusMap.getBoundingClientRect();
        if (clientRect.width === 0 || clientRect.height === 0) return;
        const scaleX = currentViewBox.width / clientRect.width;
        const scaleY = currentViewBox.height / clientRect.height;
        const newX = viewBoxOnPointerDown.x - dxScreen * scaleX;
        const newY = viewBoxOnPointerDown.y - dyScreen * scaleY;
        setMapViewBox({ x: newX, y: newY, width: currentViewBox.width, height: currentViewBox.height });
    });
    function stopPointerInteractionsMouse() { 
        if (isPointerDown && !isPinching) {
            isPointerDown = false;
            campusMap.classList.remove('grabbing');
        }
    }
    campusMap.addEventListener('mouseup', stopPointerInteractionsMouse);
    campusMap.addEventListener('mouseleave', stopPointerInteractionsMouse);
    window.addEventListener('blur', stopPointerInteractionsMouse); 

    campusMap.addEventListener('wheel', (event) => {
      event.preventDefault();
      const pivot = screenToSVGCoords(event.clientX, event.clientY);
      if (!pivot) return;
      const zoomRatio = event.deltaY < 0 ? (1 / ZOOM_FACTOR) : ZOOM_FACTOR;
      zoomViewBox(zoomRatio, pivot);
    });

    // Touch Event Handlers
    function getTouchDistance(touch1, touch2) { /* giữ nguyên */ return Math.sqrt(Math.pow(touch1.clientX - touch2.clientX,2) + Math.pow(touch1.clientY - touch2.clientY,2));}
    function getTouchMidpoint(touch1, touch2) { /* giữ nguyên */ return {x:(touch1.clientX+touch2.clientX)/2, y:(touch1.clientY+touch2.clientY)/2};}
    campusMap.addEventListener('touchstart', (event) => {
        event.preventDefault();
        isPointerDown = true; 
        campusMap.classList.add('grabbing');
        if (event.touches.length === 1) {
            const touch = event.touches[0];
            pointerStartCoords = { x: touch.clientX, y: touch.clientY };
            viewBoxOnPointerDown = { x: currentViewBox.x, y: currentViewBox.y };
            tapStart = { x: touch.clientX, y: touch.clientY, time: Date.now() };
            isPinching = false; 
        } else if (event.touches.length === 2) {
            isPinching = true;
            initialPinchDistance = getTouchDistance(event.touches[0], event.touches[1]);
            viewBoxOnPointerDown = { ...currentViewBox }; 
        }
    }, { passive: false });
    campusMap.addEventListener('touchmove', (event) => {
        event.preventDefault();
        if (!isPointerDown) return;
        if (isPinching && event.touches.length === 2) {
            const currentPinchDistance = getTouchDistance(event.touches[0], event.touches[1]);
            if (initialPinchDistance < 1) { // Tránh chia cho 0 hoặc giá trị quá nhỏ
                initialPinchDistance = currentPinchDistance; // Reset nếu khoảng cách ban đầu không hợp lệ
                viewBoxOnPointerDown = { ...currentViewBox }; // Cập nhật lại viewBox tham chiếu
                return;
            }
            const zoomRatio = currentPinchDistance / initialPinchDistance;
            const screenMidpoint = getTouchMidpoint(event.touches[0], event.touches[1]);
            const svgMidpoint = screenToSVGCoords(screenMidpoint.x, screenMidpoint.y);
            if (svgMidpoint) {
                const newWidth = viewBoxOnPointerDown.width / zoomRatio;
                const newHeight = viewBoxOnPointerDown.height / zoomRatio;
                let finalWidth = Math.max(MIN_ZOOM_WIDTH, Math.min(newWidth, MAX_ZOOM_WIDTH));
                let finalHeight = finalWidth * (SVG_ORIGINAL_HEIGHT / SVG_ORIGINAL_WIDTH);
                // Điều chỉnh lại X, Y dựa trên pivot và width/height đã bị giới hạn
                let newViewBoxX = svgMidpoint.x - (svgMidpoint.x - viewBoxOnPointerDown.x) * (finalWidth / viewBoxOnPointerDown.width);
                let newViewBoxY = svgMidpoint.y - (svgMidpoint.y - viewBoxOnPointerDown.y) * (finalHeight / viewBoxOnPointerDown.height);
                setMapViewBox({x: newViewBoxX, y: newViewBoxY, width: finalWidth, height: finalHeight});
            }
        } else if (!isPinching && event.touches.length === 1) {
            const touch = event.touches[0];
            const dxScreen = touch.clientX - pointerStartCoords.x;
            const dyScreen = touch.clientY - pointerStartCoords.y;
            const clientRect = campusMap.getBoundingClientRect();
            if (clientRect.width === 0 || clientRect.height === 0) return;
            const scaleX = currentViewBox.width / clientRect.width;
            const scaleY = currentViewBox.height / clientRect.height;
            const newX = viewBoxOnPointerDown.x - dxScreen * scaleX;
            const newY = viewBoxOnPointerDown.y - dyScreen * scaleY;
            setMapViewBox({ x: newX, y: newY, width: currentViewBox.width, height: currentViewBox.height });
        }
    }, { passive: false });
    campusMap.addEventListener('touchend', (event) => {
        if (!isPinching && event.changedTouches.length === 1 && isPointerDown) {
            const touch = event.changedTouches[0];
            const timeElapsed = Date.now() - tapStart.time;
            const distMoved = Math.sqrt(Math.pow(touch.clientX - tapStart.x, 2) + Math.pow(touch.clientY - tapStart.y, 2));
            if (timeElapsed < TAP_THRESHOLD_MS && distMoved < TAP_MOVE_THRESHOLD_PX) {
                let targetElement = document.elementFromPoint(tapStart.x, tapStart.y);
                if (targetElement && targetElement.closest && targetElement.closest('.building-rect')) {
                    targetElement = targetElement.closest('.building-rect');
                    const buildingId = targetElement.id;
                    if (buildingId && info[buildingId]) {
                        displayBuildingInfo(info[buildingId], buildingId);
                    }
                }
            }
        }
        if (event.touches.length < 2) isPinching = false;
        if (event.touches.length === 0) {
            if(isPointerDown) {
               isPointerDown = false;
               campusMap.classList.remove('grabbing');
            }
        }
    });
    campusMap.addEventListener('touchcancel', (event) => {
        isPointerDown = false;
        isPinching = false;
        campusMap.classList.remove('grabbing');
    });


    // --- New Button Click Handlers ---
    document.getElementById('zoomQ1Bottom').addEventListener('click', () => setMapViewBox(quadrantViewBoxes.q1));
    document.getElementById('zoomQ2Bottom').addEventListener('click', () => setMapViewBox(quadrantViewBoxes.q2));
    document.getElementById('zoomQ3Bottom').addEventListener('click', () => setMapViewBox(quadrantViewBoxes.q3));
    document.getElementById('zoomQ4Bottom').addEventListener('click', () => setMapViewBox(quadrantViewBoxes.q4));
    document.getElementById('resetZoomBtnBottom').addEventListener('click', () => {
      setMapViewBox({ x: 0, y: 0, width: SVG_ORIGINAL_WIDTH, height: SVG_ORIGINAL_HEIGHT });
    });

    // --- Building Info and Click Logic ---
    const info = { /* giữ nguyên */ };
    // ... (Copy object 'info' từ bản trước)
    info.toaC1 = { name: "Tòa C1", detail: "Trung tâm hành chính và các phòng ban quản lý chính của trường." };
    info.toaC2 = { name: "Tòa C2", detail: "Gồm hội trường lớn, phòng thí nghiệm vật liệu, công nghệ thông tin." };
    info.toaC7 = { name: "Tòa C7", detail: "Viện Kinh tế & Quản lý, trung tâm đào tạo quản trị." };
    info.toaB1 = { name: "Tòa B1", detail: "Trường Hóa học và Khoa học Sự sống, các phòng thí nghiệm sinh học." };
    info.toaKtx = { name: "Ký túc xá", detail: "Ký túc xá sinh viên với hơn 500 chỗ ở." };
    info.toaC9 = { name: "Tòa C9", detail: "Thông tin chi tiết về Tòa C9..." };
    info.toaHoithao = { name: "Khu Hội thảo", detail: "Thông tin chi tiết về Khu Hội thảo..." };
    info.toaC3 = { name: "Tòa C3", detail: "Thông tin chi tiết về Tòa C3..." };
    info.toaC4 = { name: "Tòa C4", detail: "Thông tin chi tiết về Tòa C4..." };
    info.toaC5 = { name: "Tòa C5", detail: "Thông tin chi tiết về Tòa C5..." };
    info.toaC10 = { name: "Tòa C10", detail: "Thông tin chi tiết về Tòa C10..." };
    info.toaThuvien = { name: "Thư viện", detail: "Thông tin chi tiết về Thư viện..." };
    info.toaHotien = { name: "Hồ Tiền", detail: "Thông tin chi tiết về Hồ Tiền..." };
    info.toaD6 = { name: "Tòa D6", detail: "Thông tin chi tiết về Tòa D6..." };
    info.toaD8 = { name: "Tòa D8", detail: "Thông tin chi tiết về Tòa D8..." };
    info.toaD2a = { name: "Tòa D2a", detail: "Thông tin chi tiết về Tòa D2a..." };
    info.toaD2b = { name: "Tòa D2b", detail: "Thông tin chi tiết về Tòa D2b..." };
    info.toaVietduc = { name: "Trung tâm Việt Đức", detail: "Thông tin chi tiết về Trung tâm Việt Đức..." };
    info.toaD2d = { name: "Tòa D2d", detail: "Thông tin chi tiết về Tòa D2d..." };
    info.toaC3b = { name: "Tòa C3b", detail: "Thông tin chi tiết về Tòa C3b..." };
    info.toaC1b = { name: "Tòa C1b", detail: "Thông tin chi tiết về Tòa C1b..." };
    info.toaD3 = { name: "Tòa D3", detail: "Thông tin chi tiết về Tòa D3..." };
    info.toaD5 = { name: "Tòa D5", detail: "Thông tin chi tiết về Tòa D5..." };
    info.toaD35 = { name: "Khối nhà D3-D5", detail: "Thông tin chi tiết về Khối nhà D3-D5..." };
    info.toaB6 = { name: "Tòa B6", detail: "Thông tin chi tiết về Tòa B6..." };
    info.toaB7 = { name: "Tòa B7", detail: "Thông tin chi tiết về Tòa B7..." };
    info.toaB8 = { name: "Tòa B8", detail: "Thông tin chi tiết về Tòa B8..." };
    info.toaB5 = { name: "Tòa B5", detail: "Thông tin chi tiết về Tòa B5..." };
    info.toaB9 = { name: "Tòa B9", detail: "Thông tin chi tiết về Tòa B9..." };
    info.toaD4 = { name: "Tòa D4", detail: "Thông tin chi tiết về Tòa D4..." };
    info.toaVuonhoa = { name: "Vườn hoa", detail: "Thông tin chi tiết về Vườn hoa..." };
    info.toaD7 = { name: "Tòa D7", detail: "Thông tin chi tiết về Tòa D7..." };


    function displayBuildingInfo(data, buildingId) { /* giữ nguyên */ }
     // Hàm displayBuildingInfo
    function displayBuildingInfo(data, buildingId) {
        if (data) {
            infoPanel.innerHTML = `<h3>${data.name}</h3><p>${data.detail}</p>`;
        } else {
            infoPanel.innerHTML = `<h3>Thông tin tòa nhà</h3><p class="placeholder">Chưa có thông tin chi tiết cho khu vực này (ID: ${buildingId}).</p>`;
        }
    }
    
    document.querySelectorAll('.building-rect').forEach(el => { /* giữ nguyên */ });
    // Gắn sự kiện click cho các tòa nhà (chủ yếu cho desktop)
    document.querySelectorAll('.building-rect').forEach(el => {
        el.addEventListener('click', (event) => {
            const timeSinceTapStart = Date.now() - tapStart.time;
            const distMoved = Math.sqrt(Math.pow(event.clientX - tapStart.x, 2) + Math.pow(event.clientY - tapStart.y, 2));

            if (isPinching || (isPointerDown && (timeSinceTapStart > TAP_THRESHOLD_MS || distMoved > TAP_MOVE_THRESHOLD_PX )) ){
                return;
            }
            
            const buildingId = event.target.id;
            if (buildingId && info[buildingId]) {
                clearSearchHighlight(); // Xóa highlight từ search nếu có
                isPointerDown = false; 
                campusMap.classList.remove('grabbing');
                displayBuildingInfo(info[buildingId], buildingId);
                // Đóng danh sách kết quả tìm kiếm nếu đang mở
                searchResultsContainer.style.display = 'none';
                searchInput.value = ''; // Xóa ô tìm kiếm
            }
        });
    });


    // --- SEARCH FUNCTIONALITY ---
    function normalizeString(str) {
      if (!str) return '';
      return str.toLowerCase()
          .normalize("NFD") // Tách dấu và chữ cái
          .replace(/[\u0300-\u036f]/g, "") // Bỏ các dấu thanh, dấu mũ, ...
          .replace(/đ/g, "d"); // Chuyển đổi 'đ' thành 'd'
    }

    function debounce(func, delay) {
      return function(...args) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => func.apply(this, args), delay);
      };
    }
    
    let currentHighlightedRect = null;
    function clearSearchHighlight() {
        if (currentHighlightedRect) {
            currentHighlightedRect.classList.remove('search-highlight');
            currentHighlightedRect = null;
        }
        clearTimeout(highlightTimeout);
    }

    function performSearch() {
      clearSearchHighlight();
      const query = searchInput.value;
      const normalizedQuery = normalizeString(query);
      searchResultsList.innerHTML = ''; // Xóa kết quả cũ

      if (!query.trim()) {
        searchResultsContainer.style.display = 'none';
        return;
      }

      const matches = [];
      for (const id in info) {
        const building = info[id];
        const normalizedName = normalizeString(building.name);
        const normalizedId = normalizeString(id);

        if (normalizedName.includes(normalizedQuery) || normalizedId.includes(normalizedQuery)) {
          matches.push({ id, ...building });
        }
      }

      matches.sort((a, b) => a.name.localeCompare(b.name, 'vi')); // Sắp xếp theo Tiếng Việt

      if (matches.length > 0) {
        matches.slice(0, 7).forEach(building => { // Hiển thị tối đa 7 kết quả
          const li = document.createElement('li');
          li.textContent = building.name + (building.id !== building.name.toLowerCase().replace(/\s+/g,'') ? ` (${building.id})` : ''); // Hiển thị ID nếu khác tên
          li.dataset.buildingId = building.id;
          li.addEventListener('click', () => handleSearchResultClick(building.id));
          searchResultsList.appendChild(li);
        });
        searchResultsContainer.style.display = 'block';
      } else {
        searchResultsList.innerHTML = '<li class="no-results">Không có kết quả phù hợp.</li>';
        searchResultsContainer.style.display = 'block';
      }
    }

    function handleSearchResultClick(buildingId) {
      clearSearchHighlight();
      const buildingData = info[buildingId];
      const buildingRectEl = document.getElementById(buildingId);

      if (buildingData && buildingRectEl) {
        // 1. Pan & Zoom
        const rectCoords = buildingRectEl.getBBox(); // Lấy tọa độ và kích thước thực của rect trong SVG space
        
        let targetViewBoxWidth, targetViewBoxHeight;
        const aspectRatio = SVG_ORIGINAL_WIDTH / SVG_ORIGINAL_HEIGHT;
        const rectAspectRatio = rectCoords.width / rectCoords.height;

        // Zoom sao cho tòa nhà chiếm khoảng 60% view, giữ tỷ lệ của viewBox
        if (rectAspectRatio > aspectRatio) { // Tòa nhà rộng hơn so với view
            targetViewBoxWidth = rectCoords.width / 0.6;
            targetViewBoxHeight = targetViewBoxWidth / aspectRatio;
        } else { // Tòa nhà cao hơn hoặc bằng so với view
            targetViewBoxHeight = rectCoords.height / 0.6;
            targetViewBoxWidth = targetViewBoxHeight * aspectRatio;
        }
        
        // Đảm bảo không zoom quá mức
        targetViewBoxWidth = Math.max(MIN_ZOOM_WIDTH, Math.min(targetViewBoxWidth, MAX_ZOOM_WIDTH*0.8)); // Giảm max zoom một chút để còn thấy xung quanh
        targetViewBoxHeight = targetViewBoxWidth / aspectRatio;


        const targetX = rectCoords.x + rectCoords.width / 2 - targetViewBoxWidth / 2;
        const targetY = rectCoords.y + rectCoords.height / 2 - targetViewBoxHeight / 2;
        
        setMapViewBox({ x: targetX, y: targetY, width: targetViewBoxWidth, height: targetViewBoxHeight });

        // 2. Highlight Building
        buildingRectEl.classList.add('search-highlight');
        currentHighlightedRect = buildingRectEl;
        highlightTimeout = setTimeout(() => {
            clearSearchHighlight();
        }, 3000); // Highlight trong 3 giây

        // 3. Open Info Panel
        displayBuildingInfo(buildingData, buildingId);

        // 4. Clear Search
        searchInput.value = '';
        searchResultsContainer.style.display = 'none';
      }
    }

    searchInput.addEventListener('input', debounce(performSearch, 300));
    
    // Đóng kết quả tìm kiếm khi click ra ngoài
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) {
            searchResultsContainer.style.display = 'none';
        }
    });
    // Đóng kết quả tìm kiếm khi nhấn Escape
    searchInput.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            searchInput.value = '';
            searchResultsContainer.style.display = 'none';
            searchInput.blur(); // Bỏ focus khỏi ô input
        }
    });


  </script>

</body>
</html>
